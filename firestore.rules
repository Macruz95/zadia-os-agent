rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check user role via Custom Claims (secure)
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }
    
    // Helper function to check if user has admin role
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Helper function to check if user has manager or admin role
    function isManagerOrAdmin() {
      return hasRole('manager') || hasRole('admin');
    }
    
    // Users collection - users can only read/write their own profile
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && isValidUserData();
      allow update: if isOwner(userId) && isValidUserUpdate();
      allow delete: if isAdmin(); // Only admins can delete users
      
      // Validate user data on creation
      function isValidUserData() {
        let data = request.resource.data;
        return data.keys().hasAll(['email', 'displayName', 'role', 'language', 'createdAt', 'lastLogin', 'isActive']) &&
               data.role == 'user' && // New users can only be created with 'user' role
               data.email == request.auth.token.email &&
               data.isActive == true;
      }
      
      // Validate user data on update - prevent role escalation
      function isValidUserUpdate() {
        let data = request.resource.data;
        let existingData = resource.data;
        return !data.diff(existingData).affectedKeys().hasAny(['role', 'email', 'createdAt']) ||
               isAdmin(); // Only admins can change critical fields
      }
    }
    
    // Projects collection - only project members can access
    match /projects/{projectId} {
      allow read, write: if isAuthenticated() && 
        (isProjectMember(projectId) || isManagerOrAdmin());
      
      function isProjectMember(projectId) {
        return request.auth.uid in resource.data.members;
      }
    }
    
    // Clients collection - secured with proper authentication
    match /clients/{clientId} {
      allow read: if isAuthenticated() && (isOwnerData(clientId) || isManagerOrAdmin());
      allow create: if isAuthenticated() && isManagerOrAdmin() && isValidClientData();
      allow update: if isAuthenticated() && (isOwnerData(clientId) || isManagerOrAdmin()) && isValidClientUpdate();
      allow delete: if isAuthenticated() && isAdmin();
      
      function isOwnerData(clientId) {
        return resource.data.createdBy == request.auth.uid;
      }
      
      function isValidClientData() {
        let data = request.resource.data;
        return data.keys().hasAll(['name', 'documentId', 'clientType', 'status', 'createdBy', 'createdAt']) &&
               data.createdBy == request.auth.uid &&
               data.clientType in ['PersonaNatural', 'OrganizaciÃ³n', 'Empresa'] &&
               data.status in ['Potencial', 'Activo', 'Inactivo'];
      }
      
      function isValidClientUpdate() {
        let data = request.resource.data;
        let existingData = resource.data;
        return !data.diff(existingData).affectedKeys().hasAny(['createdBy', 'createdAt']) ||
               isAdmin();
      }
    }

    // Contacts collection - secured with client ownership validation
    match /contacts/{contactId} {
      allow read: if isAuthenticated() && (isContactOwner(contactId) || isManagerOrAdmin());
      allow create: if isAuthenticated() && isManagerOrAdmin() && isValidContactData();
      allow update: if isAuthenticated() && (isContactOwner(contactId) || isManagerOrAdmin());
      allow delete: if isAuthenticated() && (isContactOwner(contactId) || isAdmin());
      
      function isContactOwner(contactId) {
        return resource.data.clientId != null && 
               exists(/databases/$(database)/documents/clients/$(resource.data.clientId)) &&
               get(/databases/$(database)/documents/clients/$(resource.data.clientId)).data.createdBy == request.auth.uid;
      }
      
      function isValidContactData() {
        let data = request.resource.data;
        return data.keys().hasAll(['clientId', 'phone', 'createdBy']) &&
               data.createdBy == request.auth.uid &&
               exists(/databases/$(database)/documents/clients/$(data.clientId));
      }
    }

    // Interactions collection - secured with client ownership validation
    match /interactions/{interactionId} {
      allow read: if isAuthenticated() && (isInteractionOwner(interactionId) || isManagerOrAdmin());
      allow create: if isAuthenticated() && isManagerOrAdmin() && isValidInteractionData();
      allow update: if isAuthenticated() && (isInteractionOwner(interactionId) || isManagerOrAdmin());
      allow delete: if isAuthenticated() && isAdmin();
      
      function isInteractionOwner(interactionId) {
        return resource.data.clientId != null && 
               exists(/databases/$(database)/documents/clients/$(resource.data.clientId)) &&
               get(/databases/$(database)/documents/clients/$(resource.data.clientId)).data.createdBy == request.auth.uid;
      }
      
      function isValidInteractionData() {
        let data = request.resource.data;
        return data.keys().hasAll(['clientId', 'type', 'createdBy']) &&
               data.createdBy == request.auth.uid &&
               exists(/databases/$(database)/documents/clients/$(data.clientId));
      }
    }

    // Transactions collection - secured with authentication and validation
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && (isTransactionOwner(transactionId) || isManagerOrAdmin());
      allow create: if isAuthenticated() && isManagerOrAdmin() && isValidTransactionData();
      allow update: if isAuthenticated() && (isTransactionOwner(transactionId) || isManagerOrAdmin());
      allow delete: if isAuthenticated() && isAdmin();
      
      function isTransactionOwner(transactionId) {
        return resource.data.createdBy == request.auth.uid;
      }
      
      function isValidTransactionData() {
        let data = request.resource.data;
        return data.keys().hasAll(['clientId', 'amount', 'type', 'status', 'createdBy']) &&
               data.createdBy == request.auth.uid &&
               data.amount is number && data.amount >= 0;
      }
    }

    // Projects collection - secured with authentication
    match /projects/{projectId} {
      allow read: if isAuthenticated() && (isProjectOwner(projectId) || isManagerOrAdmin());
      allow create: if isAuthenticated() && isManagerOrAdmin() && isValidProjectData();
      allow update: if isAuthenticated() && (isProjectOwner(projectId) || isManagerOrAdmin());
      allow delete: if isAuthenticated() && isAdmin();
      
      function isProjectOwner(projectId) {
        return resource.data.createdBy == request.auth.uid || 
               request.auth.uid in resource.data.members;
      }
      
      function isValidProjectData() {
        let data = request.resource.data;
        return data.keys().hasAll(['name', 'clientId', 'status', 'createdBy']) &&
               data.createdBy == request.auth.uid &&
               exists(/databases/$(database)/documents/clients/$(data.clientId));
      }
    }

    // Quotes collection - secured with authentication
    match /quotes/{quoteId} {
      allow read: if isAuthenticated() && (isQuoteOwner(quoteId) || isManagerOrAdmin());
      allow create: if isAuthenticated() && isManagerOrAdmin() && isValidQuoteData();
      allow update: if isAuthenticated() && (isQuoteOwner(quoteId) || isManagerOrAdmin());
      allow delete: if isAuthenticated() && isAdmin();
      
      function isQuoteOwner(quoteId) {
        return resource.data.createdBy == request.auth.uid;
      }
      
      function isValidQuoteData() {
        let data = request.resource.data;
        return data.keys().hasAll(['clientId', 'total', 'status', 'createdBy']) &&
               data.createdBy == request.auth.uid &&
               data.total is number && data.total >= 0;
      }
    }

    // Meetings collection - secured with authentication
    match /meetings/{meetingId} {
      allow read: if isAuthenticated() && (isMeetingParticipant(meetingId) || isManagerOrAdmin());
      allow create: if isAuthenticated() && isManagerOrAdmin() && isValidMeetingData();
      allow update: if isAuthenticated() && (isMeetingParticipant(meetingId) || isManagerOrAdmin());
      allow delete: if isAuthenticated() && isAdmin();
      
      function isMeetingParticipant(meetingId) {
        return resource.data.createdBy == request.auth.uid ||
               request.auth.uid in resource.data.attendees;
      }
      
      function isValidMeetingData() {
        let data = request.resource.data;
        return data.keys().hasAll(['date', 'attendees', 'createdBy']) &&
               data.createdBy == request.auth.uid &&
               data.attendees is list;
      }
    }    // Tasks collection - project-based access
    match /tasks/{taskId} {
      allow read, write: if isAuthenticated() && 
        (request.auth.uid == resource.data.assignedTo || 
         request.auth.uid == resource.data.createdBy ||
         isManagerOrAdmin());
    }
    
    // Analytics collection - admin only
    match /analytics/{document} {
      allow read, write: if isAdmin();
    }
    
    // System logs - admin only
    match /logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Logs should only be written by server-side functions
    }
    
    // Default deny for any other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}