rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===========================
    // HELPER FUNCTIONS
    // ===========================
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserId() {
      return request.auth.uid;
    }

    // Check if user is a member of the specified tenant
    function isTenantMember(tenantId) {
      return isAuthenticated() &&
        tenantId != null &&
        exists(/databases/$(database)/documents/tenantMembers/$(tenantId + '_' + getUserId()));
    }

    // Check if the document's tenantId matches a tenant the user belongs to
    function canAccessByTenantId() {
      return isAuthenticated() && 
        resource.data.tenantId != null &&
        isTenantMember(resource.data.tenantId);
    }

    // Check access via project's tenantId (for project-related subcollections without direct tenantId)
    function canAccessViaProject(projectId) {
      return isAuthenticated() && 
        projectId != null &&
        isTenantMember(get(/databases/$(database)/documents/projects/$(projectId)).data.tenantId);
    }

    // Check if can access by projectId field in document
    function canAccessByProjectId() {
      return isAuthenticated() && 
        resource.data.projectId != null &&
        canAccessViaProject(resource.data.projectId);
    }

    // Check if can write with projectId field
    function canWriteByProjectId() {
      return isAuthenticated() && 
        request.resource.data.projectId != null &&
        canAccessViaProject(request.resource.data.projectId);
    }

    // Check access via workPeriod's tenantId (for HR-related collections)
    function canAccessViaWorkPeriod(workPeriodId) {
      return isAuthenticated() && 
        workPeriodId != null &&
        isTenantMember(get(/databases/$(database)/documents/workPeriods/$(workPeriodId)).data.tenantId);
    }

    // Check if can access by workPeriodId field in document
    function canAccessByWorkPeriodId() {
      return isAuthenticated() && 
        resource.data.workPeriodId != null &&
        canAccessViaWorkPeriod(resource.data.workPeriodId);
    }

    // Check if can write with workPeriodId field
    function canWriteByWorkPeriodId() {
      return isAuthenticated() && 
        request.resource.data.workPeriodId != null &&
        canAccessViaWorkPeriod(request.resource.data.workPeriodId);
    }

    // Check if the incoming data's tenantId is valid for the user
    function canWriteWithTenantId() {
      return isAuthenticated() && 
        request.resource.data.tenantId != null &&
        isTenantMember(request.resource.data.tenantId);
    }

    // ===========================
    // TENANTS COLLECTION
    // ===========================
    match /tenants/{tenantId} {
      // Read: any authenticated user can read (needed for queries and slug checks)
      allow read: if isAuthenticated();
      // Create: any authenticated user can create (they become owner)
      allow create: if isAuthenticated() && request.resource.data.ownerId == getUserId();
      // Update/Delete: only the owner
      allow update, delete: if isAuthenticated() && resource.data.ownerId == getUserId();
    }

    // ===========================
    // TENANT MEMBERS COLLECTION
    // ===========================
    match /tenantMembers/{memberId} {
      // Read: user can read their own memberships or members of their tenant
      allow read: if isAuthenticated() && (
        resource.data.userId == getUserId() ||
        isTenantMember(resource.data.tenantId)
      );
      // Create: user can create their own membership (for new tenant) or tenant admin can add
      allow create: if isAuthenticated() && (
        request.resource.data.userId == getUserId() ||
        isTenantMember(request.resource.data.tenantId)
      );
      // Update/Delete: only tenant members with access
      allow update, delete: if isAuthenticated() && isTenantMember(resource.data.tenantId);
    }

    // ===========================
    // USERS COLLECTION (Personal profiles)
    // ===========================
    match /users/{userId} {
      allow read, write: if isAuthenticated() && getUserId() == userId;
    }

    // ===========================
    // MASTER DATA COLLECTIONS (Read-only reference data)
    // ===========================
    match /countries/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /municipalities/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /districts/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /departments/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ===========================
    // TENANT-SCOPED BUSINESS COLLECTIONS
    // All these collections require tenantId field for data isolation
    // ===========================
    
    // Clients
    match /clients/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Contacts (client contacts)
    match /contacts/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Interactions
    match /interactions/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Leads
    match /leads/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Opportunities
    match /opportunities/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Projects
    match /projects/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
      
      // Work Sessions subcollection within projects
      match /workSessions/{sessionId} {
        allow read: if isAuthenticated() && 
          isTenantMember(get(/databases/$(database)/documents/projects/$(docId)).data.tenantId);
        allow create: if isAuthenticated() && 
          isTenantMember(get(/databases/$(database)/documents/projects/$(docId)).data.tenantId);
        allow update, delete: if isAuthenticated() && 
          isTenantMember(get(/databases/$(database)/documents/projects/$(docId)).data.tenantId);
      }
    }

    // Project Tasks (has projectId field, may not have tenantId)
    match /projectTasks/{docId} {
      allow read: if canAccessByTenantId() || canAccessByProjectId();
      allow create: if canWriteWithTenantId() || canWriteByProjectId();
      allow update, delete: if canAccessByTenantId() || canAccessByProjectId();
    }

    // Work Orders (has projectId field, may not have tenantId)
    match /workOrders/{docId} {
      allow read: if canAccessByTenantId() || canAccessByProjectId();
      allow create: if canWriteWithTenantId() || canWriteByProjectId();
      allow update, delete: if canAccessByTenantId() || canAccessByProjectId();
    }

    // Work Sessions (has projectId field, may not have tenantId)
    match /workSessions/{docId} {
      allow read: if canAccessByTenantId() || canAccessByProjectId();
      allow create: if canWriteWithTenantId() || canWriteByProjectId();
      allow update, delete: if canAccessByTenantId() || canAccessByProjectId();
    }

    // Project Expenses (has projectId field, may not have tenantId)
    match /projectExpenses/{docId} {
      allow read: if canAccessByTenantId() || canAccessByProjectId();
      allow create: if canWriteWithTenantId() || canWriteByProjectId();
      allow update, delete: if canAccessByTenantId() || canAccessByProjectId();
    }

    // Project Timeline (has projectId field, may not have tenantId)
    match /projectTimeline/{docId} {
      allow read: if canAccessByTenantId() || canAccessByProjectId();
      allow create: if canWriteWithTenantId() || canWriteByProjectId();
      allow update, delete: if canAccessByTenantId() || canAccessByProjectId();
    }

    // Invoices
    match /invoices/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Quotes
    match /quotes/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Expenses
    match /expenses/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Payments
    match /payments/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Employees
    match /employees/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Work Periods
    match /workPeriods/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Loans (has workPeriodId field, may not have valid tenantId)
    match /loans/{docId} {
      allow read: if canAccessByTenantId() || canAccessByWorkPeriodId();
      allow create: if canWriteWithTenantId() || canWriteByWorkPeriodId();
      allow update, delete: if canAccessByTenantId() || canAccessByWorkPeriodId();
    }

    // Bonuses (has workPeriodId field, may not have tenantId)
    match /bonuses/{docId} {
      allow read: if canAccessByTenantId() || canAccessByWorkPeriodId();
      allow create: if canWriteWithTenantId() || canWriteByWorkPeriodId();
      allow update, delete: if canAccessByTenantId() || canAccessByWorkPeriodId();
    }

    // Loan Payments (abonos a pr√©stamos - has workPeriodId field)
    match /loanPayments/{docId} {
      allow read: if canAccessByTenantId() || canAccessByWorkPeriodId();
      allow create: if canWriteWithTenantId() || canWriteByWorkPeriodId();
      allow update, delete: if canAccessByTenantId() || canAccessByWorkPeriodId();
    }

    // Inventory Products
    match /products/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Inventory Categories
    match /categories/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Inventory Movements
    match /inventoryMovements/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Tasks (RICE-Z)
    match /tasks/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Events (Calendar)
    match /events/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Workflows
    match /workflows/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Workflow Executions
    match /workflow-executions/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Tenant Invitations
    match /tenantInvitations/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Custom Roles
    match /customRoles/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // Tenant Branding
    match /tenant-branding/{tenantId} {
      allow read, write: if isTenantMember(tenantId);
    }

    // ===========================
    // AI CONVERSATIONS (Nested under tenant for persistence)
    // Structure: tenants/{tenantId}/ai_conversations/{userId}/chats/{chatId}
    // ===========================
    match /tenants/{tenantId}/ai_conversations/{userId}/chats/{chatId} {
      // Users can only access their own conversations within their tenant
      allow read, write: if isAuthenticated() && 
        isTenantMember(tenantId) && 
        getUserId() == userId;
    }

    // Notifications
    match /notifications/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == getUserId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if isAuthenticated() && resource.data.userId == getUserId();
    }

    // AI Conversations
    match /ai-conversations/{docId} {
      allow read: if canAccessByTenantId();
      allow create: if canWriteWithTenantId();
      allow update, delete: if canAccessByTenantId();
    }

    // AI Messages (subcollection)
    match /ai-conversations/{conversationId}/messages/{messageId} {
      allow read, write: if isAuthenticated();
    }

    // ===========================
    // AI LEARNING SYSTEM (User-scoped, not tenant-scoped)
    // ===========================
    
    // AI User Preferences
    match /ai-user-preferences/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == getUserId();
      allow create: if isAuthenticated() && request.resource.data.userId == getUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == getUserId();
    }

    // AI Learned Patterns
    match /ai-learned-patterns/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == getUserId();
      allow create: if isAuthenticated() && request.resource.data.userId == getUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == getUserId();
    }

    // AI Semantic Memories
    match /ai-semantic-memories/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == getUserId();
      allow create: if isAuthenticated() && request.resource.data.userId == getUserId();
      allow update, delete: if isAuthenticated() && resource.data.userId == getUserId();
    }
  }
}
