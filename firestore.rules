rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================
    // HELPER FUNCTIONS
    // ===========================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserId() {
      return request.auth.uid;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'super-admin'];
    }
    
    function isOwner(ownerId) {
      return isAuthenticated() && getUserId() == ownerId;
    }
    
    function isOwnerOrAdmin(ownerId) {
      return isOwner(ownerId) || isAdmin();
    }
    
    // Validation helpers
    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }
    
    function isValidTimestamp(value) {
      return value is timestamp;
    }
    
    function isValidNumber(value) {
      return value is number && value >= 0;
    }
    
    function isValidString(value) {
      return value is string && value.size() > 0;
    }
    
    // ===========================
    // USERS COLLECTION
    // ===========================
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      // Users can update their own profile, admins can update all
      allow update: if isOwner(userId) || isAdmin();
      // Users can create their own profile
      allow create: if isOwner(userId) || isAdmin();
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // ===========================
    // CLIENTS MODULE
    // ===========================
    match /clients/{clientId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
      
      // Client contacts subcollection
      match /contacts/{contactId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // Root contacts collection (legacy compatibility)
    match /contacts/{contactId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Client interactions collection
    match /interactions/{interactionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ===========================
    // SALES MODULE
    // ===========================
    
    // Leads
    match /leads/{leadId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
      
      // Lead interactions subcollection
      match /interactions/{interactionId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // Opportunities
    match /opportunities/{opportunityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
      
      // Opportunity interactions subcollection
      match /interactions/{interactionId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // Quotes
    match /quotes/{quoteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && hasRequiredFields(request.resource.data, ['clientId', 'total', 'status'])
        && isValidNumber(request.resource.data.total)
        && isValidTimestamp(request.resource.data.createdAt);
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Quote Templates
    match /quote-templates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Sales Targets
    match /sales-targets/{targetId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ===========================
    // PROJECTS MODULE
    // ===========================
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
      
      // Project tasks subcollection
      match /tasks/{taskId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Project timeline subcollection
      match /timeline/{timelineId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Project documents subcollection
      match /documents/{documentId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Project expenses subcollection
      match /expenses/{expenseId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Project transactions subcollection (ingresos/gastos)
      match /transactions/{transactionId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Project work sessions subcollection (timer tracking)
      match /workSessions/{sessionId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ===========================
    // FINANCE MODULE
    // ===========================
    
    // Invoices
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && hasRequiredFields(request.resource.data, ['clientId', 'total', 'status'])
        && isValidNumber(request.resource.data.total)
        && isValidTimestamp(request.resource.data.createdAt);
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Payments
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && hasRequiredFields(request.resource.data, ['invoiceId', 'amount', 'method'])
        && isValidNumber(request.resource.data.amount)
        && isValidTimestamp(request.resource.data.createdAt);
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ===========================
    // INVENTORY MODULE
    // ===========================
    
    // Raw Materials
    match /raw-materials/{materialId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Finished Products
    match /finished-products/{productId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Bill of Materials
    match /bill-of-materials/{bomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Inventory Alerts
    match /inventory-alerts/{alertId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Products (legacy)
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Materials (legacy)
    match /materials/{materialId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Inventory Movements
    match /inventory-movements/{movementId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // BOMs (Bill of Materials - legacy)
    match /boms/{bomId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // ===========================
    // ORDERS MODULE
    // ===========================
    match /orders/{orderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Work Orders (camelCase - estandarizado)
    match /workOrders/{workOrderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Work Orders (kebab-case - compatibilidad legacy)
    match /work-orders/{workOrderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Tasks (root collection for queries)
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Work Sessions (time tracking)
    match /workSessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Timeline (project history - root collection)
    match /timeline/{timelineId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Expenses (project expenses tracking)
    match /expenses/{expenseId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Project-specific collections (root level)
    match /projectTasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    match /projectExpenses/{expenseId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    match /projectTimeline/{timelineId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ===========================
    // HR MODULE
    // ===========================
    match /employees/{employeeId} {
      // Users can read employees that belong to them OR legacy employees without userId
      allow read: if isAuthenticated() && (
        !('userId' in resource.data) || 
        resource.data.userId == getUserId() || 
        isAdmin()
      );
      // Users can create employees with their userId
      allow create: if isAuthenticated() && (
        request.resource.data.userId == getUserId() || 
        isAdmin()
      );
      // Users can update their own employees or legacy employees without userId
      allow update: if isAuthenticated() && (
        !('userId' in resource.data) || 
        resource.data.userId == getUserId() || 
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Work Sessions - Time Tracking
    match /workSessions/{sessionId} {
      // Employees can read their own sessions, admins can read all
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Payroll Records
    match /payroll/{payrollId} {
      // Only admins can access payroll
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Work Periods (Temporadas)
    match /workPeriods/{periodId} {
      // Simplified rules - authenticated users can manage periods
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Loans (Pr√©stamos)
    match /loans/{loanId} {
      // Simplified rules - authenticated users can manage loans
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Bonuses (Bonificaciones/Aguinaldo/Gratificaciones)
    match /bonuses/{bonusId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // ===========================
    // GEOGRAPHICAL DATA
    // ===========================
    match /countries/{countryId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /departments/{departmentId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /municipalities/{municipalityId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /districts/{districtId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /phone-codes/{phoneCodeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ===========================
    // SYSTEM CONFIGURATION
    // ===========================
    match /system-config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ===========================
    // ANALYTICS & REPORTS
    // ===========================
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ===========================
    // NOTIFICATIONS
    // ===========================
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // ===========================
    // AI CONVERSATIONS
    // ===========================
    match /ai-conversations/{conversationId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // ===========================
    // AI LEARNING MEMORY
    // ===========================
    match /ai-semantic-memories/{memoryId} {
      // Allow authenticated users to manage their own memories
      allow read, write: if isAuthenticated();
    }

    match /ai-learned-patterns/{patternId} {
      // Allow authenticated users to manage their own patterns
      allow read, write: if isAuthenticated();
    }

    match /ai-user-preferences/{prefId} {
      // Allow authenticated users to manage their own preferences
      allow read, write: if isAuthenticated();
    }

    // ===========================
    // CALENDAR MODULE (Agenda Cognitiva)
    // ===========================
    match /events/{eventId} {
      // Users can read their own events, admins can read all
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // Users can create their own events
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && hasRequiredFields(request.resource.data, ['userId', 'title', 'startDate', 'status']);
      // Users can update their own events, admins can update all
      allow update: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // Users can delete their own events, admins can delete all
      allow delete: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
    }

    // ===========================
    // TASKS MODULE (Gestor RICE-Z)
    // ===========================
    // Tasks collection (actualizar reglas existentes para incluir filtro por userId)
    match /tasks/{taskId} {
      // Users can read their own tasks, admins can read all
      allow read: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // Users can create their own tasks
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && hasRequiredFields(request.resource.data, ['userId', 'title', 'status', 'priority', 'domain']);
      // Users can update their own tasks, admins can update all
      allow update: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // Users can delete their own tasks, admins can delete all
      allow delete: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
    }

    // ===========================
    // WORKFLOWS MODULE (Biblioteca de Flujos Cognitivos)
    // ===========================
    match /workflows/{workflowId} {
      // Get: Users can read their own workflows, admins can read all
      allow get: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // List: Allow authenticated users to list (query filters by userId in app code)
      allow list: if isAuthenticated();
      // Users can create their own workflows
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && hasRequiredFields(request.resource.data, ['userId', 'name', 'template', 'status']);
      // Users can update their own workflows, admins can update all
      allow update: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // Users can delete their own workflows, admins can delete all
      allow delete: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
    }

    // Workflow executions history
    match /workflow-executions/{executionId} {
      // Get: Users can read their own executions, admins can read all
      allow get: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // List: Allow authenticated users to list (query filters by userId in app code)
      allow list: if isAuthenticated();
      // System can create executions
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && hasRequiredFields(request.resource.data, ['userId', 'workflowId', 'status', 'startedAt']);
      // Users can update their own executions, admins can update all
      allow update: if isAuthenticated() && (isOwner(resource.data.userId) || isAdmin());
      // Only admins can delete executions
      allow delete: if isAdmin();
    }
  }
}